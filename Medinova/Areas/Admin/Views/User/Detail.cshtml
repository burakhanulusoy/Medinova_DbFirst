@model List<Medinova.Models.Appointment>

@{
    ViewBag.Title = "Detaylar";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
    int count = 0;
}

<div class="main-content-container overflow-hidden">
    <div class="row">
        <div class="col-xxl-6 col-xxxl-12">
            <div class="card bg-white p-20 pb-0 rounded-10 border border-white mb-4">
                <h3 class="mb-20">Genel Bakış</h3>
                <div class="row" style="--bs-gutter-x: 20px;">

                    <div class="col-md-6">
                        <div class="card bg-body-bg p-20 rounded-10 border border-white mb-20">
                            <div class="d-flex">
                                <div class="flex-grow-1">
                                    <h3 class="mb-10">Toplam Randevu Sayısı</h3>
                                    <h2 class="fs-26 fw-medium mb-0 lh-1">@ViewBag.TotalAppointments</h2>
                                </div>
                                <div class="flex-shrink-0 ms-sm-3">
                                    <div class="bg-primary text-center rounded-circle d-block for-mobile-width" style="width: 75px; height: 75px; line-height: 75px;">
                                        <img src="~/Templates/adminThema/fila/assets/images/total-projects.svg" alt="total-appointments">
                                    </div>
                                </div>
                            </div>
                            <div class="d-flex justify-content-between align-items-center" style="margin-top: 23px;">
                                <p class="mb-0 fs-14">Geçen aya göre</p>
                                <span class="d-flex align-content-center gap-1 bg-success bg-opacity-10 border border-success" style="padding: 3px 5px;">
                                    <i class="material-symbols-outlined fs-14 text-success">trending_up</i>
                                    <span class="lh-1 fs-14 text-success">0.75%</span>
                                </span>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="card bg-body-bg p-20 rounded-10 border border-white mb-20">
                            <div class="d-flex">
                                <div class="flex-grow-1">
                                    <h3 class="mb-10">Gelecek Randevu Sayısı</h3>
                                    <h2 class="fs-26 fw-medium mb-0 lh-1">@ViewBag.FutureAppointments</h2>
                                </div>
                                <div class="flex-shrink-0 ms-sm-3">
                                    <div class="bg-warning text-center rounded-circle d-block for-mobile-width" style="width: 75px; height: 75px; line-height: 75px;">
                                        <img src="~/Templates/adminThema/fila/assets/images/active-projects.svg" alt="active-appointments">
                                    </div>
                                </div>
                            </div>
                            <div class="d-flex justify-content-between align-items-center" style="margin-top: 23px;">
                                <p class="mb-0 fs-14">Geçen aya göre</p>
                                <span class="d-flex align-content-center gap-1 bg-danger bg-opacity-10 border border-danger" style="padding: 3px 5px;">
                                    <i class="material-symbols-outlined fs-14 text-danger">trending_down</i>
                                    <span class="lh-1 fs-14 text-danger">1.25%</span>
                                </span>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="card bg-body-bg p-20 rounded-10 border border-white mb-20">
                            <div class="d-flex">
                                <div class="flex-grow-1">
                                    <h3 class="mb-10">Toplam Yorum Sayısı</h3>
                                    <h2 class="fs-26 fw-medium mb-0 lh-1">@ViewBag.TotalTestimonials</h2>
                                </div>
                                <div class="flex-shrink-0 ms-sm-3">
                                    <div class="bg-info text-center rounded-circle d-block for-mobile-width" style="width: 75px; height: 75px; line-height: 75px;">
                                        <img src="~/Templates/adminThema/fila/assets/images/completed-projects.svg" alt="completed-appointments">
                                    </div>
                                </div>
                            </div>
                            <div class="d-flex justify-content-between align-items-center" style="margin-top: 23px;">
                                <p class="mb-0 fs-14">Geçen aya göre</p>
                                <span class="d-flex align-content-center gap-1 bg-success bg-opacity-10 border border-success" style="padding: 3px 5px;">
                                    <i class="material-symbols-outlined fs-14 text-success">trending_up</i>
                                    <span class="lh-1 fs-14 text-success">4.75%</span>
                                </span>
                            </div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="card bg-body-bg p-20 rounded-10 border border-white mb-20">
                            <div class="d-sm-flex align-items-center">
                                <div class="flex-grow-1">
                                    <h3 class="mb-10">En Çok Tercih Edilen Doktor</h3>
                                    <h2 class="fs-26 fw-medium mb-0 lh-1">@ViewBag.TopDoctor</h2>
                                </div>
                                <div class="flex-shrink-0 ms-0 mt-3 mt-sm-0">
                                    <ul class="p-0 mb-0 list-unstyled d-flex last-child-none-right global-right-list">
                                        <li style="margin-right: -15px;"><img src="~/Templates/adminThema/fila/assets/images/user12.jpg" class="border border-2 border-white rounded-circle" style="width: 37px; height: 37px;" alt="user"></li>
                                        <li style="margin-right: -15px;"><img src="~/Templates/adminThema/fila/assets/images/user13.jpg" class="border border-2 border-white rounded-circle" style="width: 37px; height: 37px;" alt="user"></li>
                                        <li style="margin-right: -15px;"><img src="~/Templates/adminThema/fila/assets/images/user14.jpg" class="border border-2 border-white rounded-circle" style="width: 37px; height: 37px;" alt="user"></li>
                                        <li style="margin-right: -15px;"><img src="~/Templates/adminThema/fila/assets/images/user15.jpg" class="border border-2 border-white rounded-circle" style="width: 37px; height: 37px;" alt="user"></li>
                                        <li class="border border-2 border-white rounded-circle bg-primary-50 text-center" style="margin-right: -15px; width: 37px; height: 37px; line-height: 34px;">
                                            <span class="text-white fs-13 fw-medium">+50</span>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                            <div style="margin-top: 45px;">
                                <p class="mb-0 fs-14">Genel Hasta Memnuniyeti %50</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xxl-6 col-xxxl-12">
            <div class="card bg-white p-20 rounded-10 border border-white mb-4 shadow-sm">
                <div class="d-flex justify-content-between align-items-center flex-wrap gap-3 mb-0">
                    <h3 style="color: #2c3e50;">Bölümlere Göre Randevu Dağılımı</h3>
                </div>
                <div id="department_roadmap_chart2" style="margin-bottom: -13px;"></div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-xxl-12 col-lg-12">
            <div class="card bg-white rounded-10 border border-white mb-4">
                <div class="d-flex justify-content-between align-items-center flex-wrap gap-3 p-20">
                    <h3>Tüm Randevular</h3>
                </div>

                <div class="default-table-area mx-minus-1 table-all-projects">
                    <div class="table-responsive">
                        <table class="table align-middle">
                            <thead>
                                <tr>
                                    <th scope="col" class="fw-medium">#</th>
                                    <th scope="col" class="fw-medium">Doktor Adı</th>
                                    <th scope="col" class="fw-medium">Departman</th>
                                    <th scope="col" class="fw-medium">Randevu Tarihi</th>
                                    <th scope="col" class="fw-medium">Durum</th>
                                    <th scope="col" class="fw-medium">Telefon Numarası</th>
                                    <th scope="col" class="fw-medium">Email</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in Model)
                                {
                                    count++;
                                    <tr>
                                        <td class="text-body">@count</td>
                                        <td class="text-body">@item.Doctor.FullName</td>
                                        <td class="text-secondary">@item.Doctor.Department.Name</td>
                                        <td class="text-body">@item.AppointmentDate.Value.ToString("dd MMM yyyy HH:mm")</td>
                                        <td class="text-body">
                                            @if (item.IsActive == true)
                                            {
                                                <span class="text-success bg-success bg-opacity-10 fs-14 fw-normal d-inline-block px-2 py-1 rounded">Onaylandı</span>
                                            }
                                            else if (item.IsActive == false)
                                            {
                                                <span class="text-danger bg-danger bg-opacity-10 fs-14 fw-normal d-inline-block px-2 py-1 rounded">Onaylanmadı</span>
                                            }
                                            else
                                            {
                                                <span class="text-warning bg-warning bg-opacity-10 fs-14 fw-normal d-inline-block px-2 py-1 rounded">Beklemede</span>
                                            }
                                        </td>
                                        <td class="text-body">@item.User.PhoneNumber</td>
                                        <td class="text-body">@item.User.Email</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>

                    <div class="d-flex justify-content-center justify-content-sm-between align-items-center text-center flex-wrap gap-2 showing-wrap pt-15 p-20">
                        <span class="fs-15">Sayfa 1 (Toplam listelenen kayıtlar gösteriliyor)</span>
                        <nav class="custom-pagination" aria-label="Page navigation">
                            <ul class="pagination mb-0 justify-content-center">
                                <li class="page-item">
                                    <button class="page-link icon" aria-label="Önceki">
                                        <i class="material-symbols-outlined">west</i>
                                    </button>
                                </li>
                                <li class="page-item"><button class="page-link active">1</button></li>
                                <li class="page-item"><button class="page-link">2</button></li>
                                <li class="page-item"><button class="page-link">3</button></li>
                                <li class="page-item">
                                    <button class="page-link icon" aria-label="Sonraki">
                                        <i class="material-symbols-outlined">east</i>
                                    </button>
                                </li>
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-4">
            <div class="card bg-white rounded-10 border border-white p-20 mb-4">
                <h3 class="mb-20">Çalışma Takvimi</h3>

                <div class="calendar-container style-two mb-20">
                    <div class="calendar-header mb-3">
                        <button id="prevMonth" class="change-btn">
                            <i class="ri-arrow-left-s-line"></i>
                        </button>
                        <div>
                            <select id="monthSelect" class="month-year border-0 bg-transparent fw-bold"></select>
                            <select id="yearSelect" class="month-year border-0 bg-transparent fw-bold"></select>
                        </div>
                        <button id="nextMonth" class="change-btn">
                            <i class="ri-arrow-right-s-line"></i>
                        </button>
                    </div>
                    <table class="calendar-table">
                        <thead>
                            <tr>
                                <th>Pzt</th>
                                <th>Sal</th>
                                <th>Çar</th>
                                <th>Per</th>
                                <th>Cum</th>
                                <th>Cmt</th>
                                <th>Paz</th>
                            </tr>
                        </thead>
                        <tbody id="calendarBody2">
                        </tbody>
                    </table>
                </div>

                <h3 class="mb-20">Etkinlikler</h3>
            </div>
        </div>

        <div class="col-lg-8">
            <div class="card bg-white rounded-10 border border-white mb-4">
                <div class="d-flex justify-content-between align-items-center flex-wrap gap-3 p-20">
                    <h3>Hasta Yorumları</h3>

                    <form class="table-src-form position-relative ms-0">
                        <input type="text" class="form-control" placeholder="Ara...">
                        <div class="src-btn position-absolute top-50 start-0 translate-middle-y bg-transparent p-0 border-0">
                            <span class="material-symbols-outlined">search</span>
                        </div>
                    </form>
                </div>

                <div class="default-table-area mx-minus-1 table-to-do-list pm-to-do-list">
                    <div class="table-responsive">
                        <table class="table align-middle">
                            <thead>
                                <tr>
                                    <th scope="col" class="fw-medium pe-0">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="selectAll">
                                        </div>
                                    </th>
                                    <th scope="col" class="fw-medium ps-0">Doktor Adı</th>
                                    <th scope="col" class="fw-medium">Yorum Tarihi</th>
                                    <th scope="col" class="fw-medium">Yorum</th>
                                    <th scope="col" class="fw-medium">Durum</th>
                                    <th scope="col" class="fw-medium">İşlem</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (ViewBag.TestimonialList != null)
                                {
                                    foreach (var item in ViewBag.TestimonialList)
                                    {
                                        <tr>
                                            <td class="text-body pe-0" style="width: 62px;">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" value="@item.TestimonialId">
                                                </div>
                                            </td>
                                            <td class="text-body ps-0">@item.Doctor.FullName</td>
                                            <td class="text-secondary">@item.CommentDate.ToString("dd MMM yyyy")</td>
                                            <td class="text-body">
                                                @(item.Comment.Length > 50 ? item.Comment.Substring(0, 50) + "..." : item.Comment)
                                            </td>
                                            <td class="text-body">
                                                @if (item.IsRead)
                                                {
                                                    <span class="text-success bg-success bg-opacity-10 fs-14 fw-normal d-inline-block px-2 py-1 rounded">Okundu</span>
                                                }
                                                else
                                                {
                                                    <span class="text-warning bg-warning bg-opacity-10 fs-14 fw-normal d-inline-block px-2 py-1 rounded">Okunmadı</span>
                                                }
                                            </td>
                                            <td>
                                                <div class="d-flex justify-content-end" style="gap: 12px;">
                                                    <button type="button" class="bg-transparent p-0 border-0 view-comment-btn"
                                                            data-bs-toggle="modal"
                                                            data-bs-target="#commentModal"
                                                            data-comment="@item.Comment"
                                                            data-doctor="@item.Doctor.FullName"
                                                            data-bs-placement="top" data-bs-title="Görüntüle">
                                                        <i class="material-symbols-outlined fs-16 fw-normal text-primary">visibility</i>
                                                    </button>
                                                    <button class="bg-transparent p-0 border-0 hover-text-danger" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Sil">
                                                        <i class="material-symbols-outlined fs-16 fw-normal text-body">delete</i>
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                    }
                                }
                                else
                                {
                                    <tr>
                                        <td colspan="6" class="text-center text-muted py-3">Gösterilecek yorum bulunamadı.</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="commentModal" tabindex="-1" aria-labelledby="commentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered rounded-10">
        <div class="modal-content bg-white">
            <div class="modal-header border-border-color-40 p-20">
                <h1 class="modal-title fs-18 fw-medium mb-0" id="modalDoctorName">Yorum Detayı</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
            </div>
            <div class="modal-body p-20">
                <p id="modalCommentText" class="text-body text-wrap text-break mb-0"></p>
            </div>
            <div class="modal-footer border-0 p-20 pt-0">
                <button type="button" class="btn btn-secondary fw-normal text-white" data-bs-dismiss="modal">Kapat</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

<script>
    // Modal İçin Script
    document.addEventListener("DOMContentLoaded", function () {
        const viewButtons = document.querySelectorAll('.view-comment-btn');
        const modalCommentText = document.getElementById('modalCommentText');
        const modalDoctorName = document.getElementById('modalDoctorName');

        viewButtons.forEach(button => {
            button.addEventListener('click', function () {
                const comment = this.getAttribute('data-comment');
                const doctor = this.getAttribute('data-doctor');
                modalDoctorName.textContent = doctor + " - Hasta Yorumu";
                modalCommentText.textContent = comment;
            });
        });
    });

    // Grafik İçin Script
    document.addEventListener("DOMContentLoaded", function () {
        const chartElement = document.querySelector('#department_roadmap_chart2');
        if (chartElement) {
            var categoriesData = @Html.Raw(Json.Encode(ViewBag.ChartLabels ?? new List<string>()));
            var seriesData = @Html.Raw(Json.Encode(ViewBag.ChartData ?? new List<int>()));

            var options = {
                series: [{ name: "Randevu Sayısı", data: seriesData }],
                chart: { type: "bar", height: 360, toolbar: { show: false } },
                colors: ["#2193b0"],
                plotOptions: { bar: { horizontal: true, borderRadius: 4 } },
                dataLabels: { enabled: true, style: { fontSize: '14px', fontFamily: 'Outfit, sans-serif' } },
                xaxis: {
                    categories: categoriesData,
                    axisBorder: { show: true, color: '#e0e0e0' },
                    axisTicks: { show: true, color: '#e0e0e0' },
                    labels: { show: true, style: { colors: "#64748b", fontSize: "14px", fontFamily: 'Outfit, sans-serif' } }
                },
                yaxis: {
                    labels: { show: true, style: { colors: "#2c3e50", fontSize: "14px", fontFamily: 'Outfit, sans-serif', fontWeight: 500 } },
                    axisBorder: { show: true, color: '#e0e0e0' },
                    axisTicks: { show: false }
                },
                grid: {
                    strokeDashArray: 5,
                    borderColor: "#f4f6fc",
                    row: { colors: ["#f4f6fc", "transparent"], opacity: 0.5 }
                },
                noData: {
                    text: 'Kayıt bulunamadı.',
                    align: 'center',
                    verticalAlign: 'middle',
                    style: { color: '#64748b', fontSize: '16px' }
                }
            };
            const chart = new ApexCharts(chartElement, options);
            chart.render();
        }
    });

    // Takvim İçin Script
    const getCalendarBodyId = document.getElementById('calendarBody2');
    if (getCalendarBodyId) {
        const appointmentDates = @Html.Raw(Json.Encode(ViewBag.AppointmentDates ?? new List<string>()));
        const calendarBody = document.getElementById('calendarBody2');
        const monthSelect = document.getElementById('monthSelect');
        const yearSelect = document.getElementById('yearSelect');
        const prevMonthBtn = document.getElementById('prevMonth');
        const nextMonthBtn = document.getElementById('nextMonth');

        const currentDate = new Date();
        let selectedMonth = currentDate.getMonth();
        let selectedYear = currentDate.getFullYear();

        // Türkçe aylar eklendi
        const monthNames = [
            "Ocak", "Şubat", "Mart", "Nisan", "Mayıs", "Haziran",
            "Temmuz", "Ağustos", "Eylül", "Ekim", "Kasım", "Aralık"
        ];

        function populateMonthAndYearSelectors() {
            monthNames.forEach((month, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = month;
                monthSelect.appendChild(option);
            });
            for (let i = currentDate.getFullYear() - 20; i <= currentDate.getFullYear() + 20; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i;
                yearSelect.appendChild(option);
            }
        }

        function generateCalendar(month, year) {
            calendarBody.innerHTML = '';
            const firstDayOfMonth = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const daysInPrevMonth = new Date(year, month, 0).getDate();

            let adjustedFirstDay = firstDayOfMonth === 0 ? 6 : firstDayOfMonth - 1;
            let date = 1;
            let prevMonthDate = daysInPrevMonth - adjustedFirstDay + 1;
            let nextMonthDate = 1;
            const today = new Date();

            for (let i = 0; i < 6; i++) {
                const row = document.createElement('tr');
                for (let j = 0; j < 7; j++) {
                    const cell = document.createElement('td');

                    if (i === 0 && j < adjustedFirstDay) {
                        cell.textContent = prevMonthDate++;
                        cell.classList.add('prev-month', 'text-muted');
                    } else if (date > daysInMonth) {
                        cell.textContent = nextMonthDate++;
                        cell.classList.add('next-month', 'text-muted');
                    } else {
                        cell.textContent = date;
                        let cellMonthStr = String(month + 1).padStart(2, '0');
                        let cellDateStr = String(date).padStart(2, '0');
                        let fullDateString = `${year}-${cellMonthStr}-${cellDateStr}`;

                        if (appointmentDates.includes(fullDateString)) {
                            let cellDateObj = new Date(year, month, date);
                            let todayObj = new Date(today.getFullYear(), today.getMonth(), today.getDate());

                            if (cellDateObj < todayObj) {
                                cell.classList.add('past-appointment');
                                cell.title = "Geçmiş Randevu";
                            } else {
                                cell.classList.add('future-appointment');
                                cell.title = "Gelecek Randevu";
                            }
                        }

                        if (year === today.getFullYear() && month === today.getMonth() && date === today.getDate()) {
                            cell.classList.add('current-day');
                            cell.style.backgroundColor = "#796df6";
                            cell.style.color = "white";
                        }
                        date++;
                    }
                    row.appendChild(cell);
                }
                calendarBody.appendChild(row);
                if (date > daysInMonth && nextMonthDate > 7) break;
            }
        }

        function updateCalendar() {
            generateCalendar(selectedMonth, selectedYear);
            monthSelect.value = selectedMonth;
            yearSelect.value = selectedYear;
        }

        monthSelect.addEventListener('change', (e) => {
            selectedMonth = parseInt(e.target.value);
            updateCalendar();
        });

        yearSelect.addEventListener('change', (e) => {
            selectedYear = parseInt(e.target.value);
            updateCalendar();
        });

        prevMonthBtn.addEventListener('click', () => {
            if (selectedMonth === 0) {
                selectedMonth = 11;
                selectedYear--;
            } else selectedMonth--;
            updateCalendar();
        });

        nextMonthBtn.addEventListener('click', () => {
            if (selectedMonth === 11) {
                selectedMonth = 0;
                selectedYear++;
            } else selectedMonth++;
            updateCalendar();
        });

        populateMonthAndYearSelectors();
        updateCalendar();
    }
</script>

<style>
    /* GEÇMİŞ RANDEVULAR İÇİN (KIRMIZI) */
    .past-appointment {
        background-color: #fee2e2 !important;
        color: #b91c1c !important;
        border: 1px solid #fca5a5 !important;
        border-radius: 8px;
        font-weight: bold;
        cursor: pointer;
        position: relative;
    }

        .past-appointment::after {
            content: '';
            position: absolute;
            bottom: 3px;
            left: 50%;
            transform: translateX(-50%);
            width: 5px;
            height: 5px;
            background-color: #b91c1c;
            border-radius: 50%;
        }

    /* GELECEK RANDEVULAR İÇİN (YEŞİL) */
    .future-appointment {
        background-color: #dcfce7 !important;
        color: #15803d !important;
        border: 1px solid #86efac !important;
        border-radius: 8px;
        font-weight: bold;
        cursor: pointer;
        position: relative;
    }

        .future-appointment::after {
            content: '';
            position: absolute;
            bottom: 3px;
            left: 50%;
            transform: translateX(-50%);
            width: 5px;
            height: 5px;
            background-color: #15803d;
            border-radius: 50%;
        }
</style>