@model List<Medinova.Models.Doctor>

@{
    ViewBag.Title = "Doktor Şikayet Paneli";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";

    string defaultDoctorImage = "https://cdn-icons-png.flaticon.com/512/387/387561.png";
}

<div class="main-content-container overflow-hidden">
    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-4 mt-1 border-bottom pb-2">
        <h3 class="mb-0 text-dark font-weight-bold">
            <i class="fas fa-user-md text-primary mr-2"></i> Doktor Şikayet ve Yorum İstatistikleri
        </h3>
    </div>

    <div class="row">
        @foreach (var item in Model)
        {
            // 1. Bu doktorun toplam şikayet/yorum sayısı
            int sikayetSayisi = item.Testimonials != null ? item.Testimonials.Count(x => x.DoctorId == item.DoctorId) : 0;

            // 2. SENİN MANTIĞIN: Herkes 100 puanla başlar, her şikayet 1 puan düşürür.
            // 1 şikayeti olanın skoru 99 olur. 80 şikayeti olanın skoru 20 olur.
            int guvenilirlikSkoru = 100 - sikayetSayisi;

            // Eğer doktorun 100'den fazla şikayeti varsa skor eksi değerlere (Örn: -5) düşmesin diye en dibi %0 olarak sabitliyoruz.
            if (guvenilirlikSkoru < 0)
            {
                guvenilirlikSkoru = 0;
            }

            // 3. Skora göre otomatik renk belirleme
            string barRengi = "bg-success"; // Varsayılan: 80-100 arası Yeşil (Güvenilir)

            if (guvenilirlikSkoru < 40)
            {
                barRengi = "bg-danger"; // Skor 40'ın altındaysa (Örn: 80 şikayet = %20 skor): Kırmızı
            }
            else if (guvenilirlikSkoru < 80)
            {
                barRengi = "bg-warning"; // Skor 40 ile 80 arasıysa: Sarı/Turuncu (Dikkatli olunmalı)
            }

            <div class="col-xxl-3 col-xxxl-4 col-lg-4 col-md-6">
                <div class="card bg-white p-20 rounded-10 border border-light mb-4 shadow-sm for-mobile-sellers transition-all">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div class="d-flex align-items-center w-100">
                            <div class="flex-shrink-0">
                                @if (!string.IsNullOrEmpty(item.ImageUrl))
                                {
                                    <img src="@item.ImageUrl" style="width: 80px; height: 80px; object-fit: cover; border: 3px solid #f8f9fa;" class="rounded-circle shadow-sm" alt="Dr. @item.FullName">
                                }
                                else
                                {
                                    <img src="@defaultDoctorImage" style="width: 80px; height: 80px; object-fit: cover; border: 3px solid #f8f9fa;" class="rounded-circle shadow-sm" alt="Varsayılan Profil">
                                }
                            </div>
                            <div class="flex-grow-1 ms-3 position-relative top-2">
                                <h4 class="mb-1 text-dark" style="font-weight: 600;">Dr. @item.FullName</h4>
                                <span class="fs-14 text-muted"><i class="fas fa-stethoscope"></i> @item.Department.Name</span>
                            </div>
                        </div>
                    </div>

                    <h5 class="mb-2 text-secondary" style="font-size: 15px;">Güvenilirlik / Başarı Skoru</h5>

                    <div class="d-flex align-items-center" style="margin-bottom: 20px;">
                        <div class="flex-shrink-0">
                            <span class="badge @barRengi fs-14 px-2 py-1">%@guvenilirlikSkoru</span>
                        </div>
                        <div class="flex-grow-1 ms-12 pl-3">
                            <div class="progress bg-light rounded-pill" role="progressbar" style="height: 8px;">
                                <div class="progress-bar @barRengi rounded-pill" style="width: @guvenilirlikSkoru%; height: 8px;"></div>
                            </div>
                        </div>
                    </div>

                    <div class="text-center mb-3">
                        <small class="text-muted"><i class="fas fa-info-circle"></i> Sistemde toplam @sikayetSayisi şikayet kaydı var.</small>
                    </div>

                    <div class="text-center">
                        <a href="/Admin/Testimonial/Detail/@item.DoctorId" class="btn btn-outline-primary btn-sm w-100 fw-bold rounded-pill">
                            <i class="fas fa-list-ul mr-1"></i> Şikayetleri İncele
                        </a>
                    </div>
                </div>
            </div>
        }
    </div>
</div>