<style>

  /* --- Profesyonel Mavi EKG Loader --- */
.medical-loader {
    width: 60px;
    height: 30px; /* Daha yayvan EKG görünümü */
    display: inline-block;
    position: relative;
}
.medical-loader::before {
    content: '';
    position: absolute;
    left: 0;
    bottom: 0;
    width: 100%;
    height: 2px;
    background-color: #e0e0e0; /* Zemin çizgisi */
}
.medical-loader::after {
    content: '';
    position: absolute;
    left: 0;
    bottom: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(to right, transparent 0%, #007bff 50%, transparent 100%);
    clip-path: polygon(0% 100%, 20% 100%, 30% 0%, 50% 100%, 60% 100%, 70% 60%, 80% 100%, 100% 100%);
    animation: ekg 1.5s linear infinite;
}

@@keyframes ekg {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
}

/* --- Validasyon Hatası (Kırmızı kalabilir, hata hatadır) --- */
@@keyframes shake {
    0% { transform: translateX(0); }
    25% { transform: translateX(-5px); }
    50% { transform: translateX(5px); }
    75% { transform: translateX(-5px); }
    100% { transform: translateX(0); }
}
.input-error {
    border: 2px solid #ff6b6b !important;
    background-color: #fff5f5 !important;
    animation: shake 0.3s ease-in-out;
}

/* --- Premium Bilet Kartı --- */
.ticket-card {
    background: #ffffff;
    border-radius: 12px;
    padding: 0;
    box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    border: 1px solid #eef2f7;
    overflow: hidden;
}
.ticket-header {
    background: #007bff; /* Hastane Mavisi */
    padding: 15px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    color: white;
}
.ticket-body {
    padding: 20px;
}
.ticket-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 12px;
    border-bottom: 1px solid #f0f0f0;
    padding-bottom: 8px;
}
.ticket-row:last-child {
    border-bottom: none;
}
.ticket-label {
    color: #8898aa;
    font-size: 13px;
    font-weight: 500;
}
.ticket-value {
    color: #32325d;
    font-weight: 700;
    font-size: 14px;
}
.success-checkmark-anim {
    width: 80px;
    height: 80px;
    margin: 0 auto 20px auto;
}
    /* Hata durumunda inputlar titrer */
@@keyframes shake {
    0% { transform: translateX(0); }
    25% { transform: translateX(-5px); }
    50% { transform: translateX(5px); }
    75% { transform: translateX(-5px); }
    100% { transform: translateX(0); }
}

.input-error {
    border: 2px solid #e74c3c !important; /* Kırmızı çerçeve */
    background-color: #fff6f6 !important; /* Hafif kırmızı zemin */
    animation: shake 0.3s ease-in-out; /* Titreşim efekti */
}

/* Toast Bildirimleri İçin Font */
.swal2-popup {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif !important;
}

    .appointment-form-card {
        border: none;
        border-radius: 20px; /* Daha yumuşak köşeler */
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); /* Modern gölge */
    }

    .form-floating > .form-control,
    .form-floating > .form-select {
        border-radius: 12px; /* Input köşeleri */
        border: 1px solid #eef0f3;
        background-color: #f8f9fa;
        height: 60px; /* Biraz daha dolgun görünüm */
    }

        .form-floating > .form-control:focus,
        .form-floating > .form-select:focus {
            background-color: #fff;
            border-color: #0d6efd; /* Bootstrap primary color */
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.15);
        }

    .btn-submit-custom {
        border-radius: 12px;
        font-weight: 600;
        letter-spacing: 0.5px;
        transition: all 0.3s ease;
        box-shadow: 0 4px 6px rgba(13, 110, 253, 0.3);
    }

        .btn-submit-custom:hover {
            transform: translateY(-2px); /* Buton hafif yukarı kalkar */
            box-shadow: 0 8px 15px rgba(13, 110, 253, 0.4);
        }
</style>

<div class="container-fluid bg-primary my-5 py-5">
    <div class="container py-5">
        <div class="row gx-5">
            <div class="col-lg-6 mb-5 mb-lg-0">
                <div class="mb-4">
                    <h5 class="d-inline-block text-white text-uppercase border-bottom border-5">Appointment</h5>
                    <h1 class="display-4">Make An Appointment For Your Family</h1>
                </div>
                <p class="text-white mb-5">
                    Eirmod sed tempor lorem ut dolores. Aliquyam sit sadipscing kasd ipsum.
                    Dolor ea et dolore et at sea ea at dolor, justo ipsum duo rebum sea invidunt voluptua. Eos vero
                    eos vero ea et dolore eirmod et. Dolores diam duo invidunt lorem. Elitr ut dolores magna sit.
                    Sea dolore sanctus sed et. Takimata takimata sanctus sed.
                </p>
                <a class="btn btn-dark rounded-pill py-3 px-5 me-3" href="#!">Find Doctor</a>
                <a class="btn btn-outline-dark rounded-pill py-3 px-5" href="#!">Read More</a>
            </div>

            <div class="col-lg-6">
                <div class="bg-white text-center p-5 appointment-form-card">

                    <h1 class="mb-4" style="color: #2c3e50;">Randevu Oluştur</h1>
                    <p class="mb-4 text-muted">Lütfen aşağıdaki formu eksiksiz doldurunuz.</p>

                    <form id="appointmentForm" method="post" action="/Default/DefaultAppointment">
                        <div class="row g-3">

                            <div class="col-12 col-sm-6">
                                <div class="form-floating">
                                    @Html.DropDownList("DepartmentId", (List<SelectListItem>)ViewBag.Departments, "Seçiniz", new { @class = "form-control" })
                                    <label for="DepartmentId">Bölüm Seçiniz</label>
                                </div>
                            </div>

                            <div class="col-12 col-sm-6">
                                <div class="form-floating">
                                    <select id="DoctorId" name="DoctorId" class="form-select">
                                        <option disabled selected>-- Önce Bölüm Seçiniz --</option>
                                    </select>
                                    <label for="DoctorId">Doktorunuzu Seçiniz</label>
                                </div>
                            </div>

                            <div class="col-12 col-sm-6">
                                <div class="form-floating">
                                    <input name="FullName" type="text" class="form-control" id="FullName" placeholder="Adınız Soyadınız">
                                    <label for="FullName">Adınız ve Soyadınız</label>
                                </div>
                            </div>

                            <div class="col-12 col-sm-6">
                                <div class="form-floating">
                                    <input name="Email" type="email" class="form-control" id="Email" placeholder="name@example.com">
                                    <label for="Email">Mail Adresiniz</label>
                                </div>
                            </div>

                            <div class="col-12 col-sm-6">
                                <div class="form-floating">
                                    <input name="PhoneNumber" type="tel" class="form-control" id="PhoneNumber" placeholder="Telefon">
                                    <label for="PhoneNumber">Telefon Numaranız</label>
                                </div>
                            </div>

                            <div class="col-12 col-sm-6">
                                <div class="form-floating">
                                    @Html.DropDownList("AppointmentDate", (List<SelectListItem>)ViewBag.DateList, "Tarih Seçiniz", new { @class = "form-control" })
                                    <label for="AppointmentDate">Randevu Tarihi</label>
                                </div>
                            </div>

                            <div class="col-12 col-sm-6">
                                <div class="form-floating">
                                    <select id="AppointmentTime" name="AppointmentTime" class="form-select">
                                        <option disabled selected>-- Önce Tarih Seçiniz --</option>
                                    </select>
                                    <label for="AppointmentTime">Randevu Saati</label>
                                </div>
                            </div>

                            <div class="col-12">
                                <button  class="btn btn-primary w-100 py-3 btn-submit-custom" type="submit">
                                    Randevu Oluştur
                                </button>
                            </div>


                        </div>
                    </form>

                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>

<script type="text/javascript">
    $(document).ready(function () {




        $("#DepartmentId").change(function () {

            var selectedDepId = $(this).val();

            var doctorDropDown = $("#DoctorId");

            var dateDropDown = $("#AppointmentDate");

            var timeDropDown = $("#AppointmentTime");

            // Bölüm değişince tarihi sıfırla yeni bilgi unutma!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
            $("#AppointmentDate").val('').trigger('change');

            $.ajax({
                url: '/Default/GetDoctorsByDepartmentId',//çalışacak action controllerda
                type: 'GET',
                data: { departmentId: selectedDepId },//parametlerşeri
                dataType: 'json',
                success: function (data) {
                    doctorDropDown.empty();
                    // Varsayılan seçenek erhan hocammmmmmmm mükemmelsıniz
                    doctorDropDown.append($('<option disabled selected></option>').val('').html('-- Doktor Seçiniz --'));

                    $.each(data, function (i, doctor) {
                        doctorDropDown.append($('<option></option>').val(doctor.Value).html(doctor.Text));
                    });
                }
            });
        });

        $("#AppointmentDate").change(function () {
            var selectedDate = $(this).val();
            var selectedDoctorId = $("#DoctorId").val();
            var timeDropDown = $("#AppointmentTime");

            $("#AppointmentTime").val('').trigger('change');


            $.ajax({
                url: '/Default/GetAvailableHours',
                type: 'POST',
                data: { selectedDate: selectedDate, doctorId: selectedDoctorId },
                dataType: 'json',
                success: function (data) {
                    timeDropDown.empty();
                    // Varsayılan seçenek
                    timeDropDown.append($('<option disabled selected></option>').val('').html('-- Saat Seçiniz --'));

                    $.each(data, function (i, item) {
                        var isDisabled = false;
                        var optionText = item.Time;

                        if (item.IsBooked) {
                            optionText += " (Dolu)";
                            isDisabled = true;
                        }

                        var option = $('<option> </option>').val(item.Time).html(optionText);

                        if (isDisabled) {
                            option.prop('disabled', true);
                        }
                        timeDropDown.append(option);
                        timeDropDown.prop('disabled', false);
                    });
                }
            });
        });







        // Toast Ayarı (Mavi Tema)
        const Toast = Swal.mixin({
            toast: true,
            position: 'top-end',
            showConfirmButton: false,
            timer: 3000,
            timerProgressBar: true,
            didOpen: (toast) => {
                toast.addEventListener('mouseenter', Swal.stopTimer)
                toast.addEventListener('mouseleave', Swal.resumeTimer)
            }
        });

        $("#appointmentForm").submit(function (e) {
            e.preventDefault();

            // --- 1. VALIDASYON (Aynen koruduk) ---
            $(".form-control, .form-select").removeClass("input-error");
            let hasError = false;
            let firstError = null;
            const fields = ['DepartmentId', 'DoctorId', 'FullName', 'Email', 'PhoneNumber', 'AppointmentDate', 'AppointmentTime'];

            fields.forEach(f => {
                let el = $("[name='" + f + "']");
                if (!el.val()) {
                    el.addClass("input-error");
                    hasError = true;
                    if (!firstError) firstError = el;
                }
            });

            if (hasError) {
                firstError.focus();
                Toast.fire({ icon: 'error', title: 'Lütfen işaretli alanları doldurunuz.' });
                return;
            }

            // Verileri Al
            var formData = $(this).serialize();
            var phoneNumber = $("#PhoneNumber").val();
            var userEmail = $("#Email").val();

            // Görsel Veriler
            var docName = $("#DoctorId option:selected").text();
            var deptName = $("#DepartmentId option:selected").text();
            var appDate = $("#AppointmentDate option:selected").text();
            var appTime = $("#AppointmentTime option:selected").text();

            // --- 2. YÜKLENİYOR (MAVİ EKG) ---
            Swal.fire({
                title: 'Sistem Bağlanıyor',
                html: `
                    <div class="my-4">
                        <div class="medical-loader"></div>
                    </div>
                    <p style="color:#6c757d; font-size:14px; font-weight:500;">
                        Müsaitlik durumu sorgulanıyor, lütfen bekleyiniz...
                    </p>
                `,
                showConfirmButton: false,
                allowOutsideClick: false,
                width: 400,
                padding: '2em',
                background: '#fff',
                didOpen: () => { Swal.showLoading(); }
            });

            // --- 3. AJAX İSTEĞİ ---
            $.ajax({
                url: '/Default/SendVerificationCode',
                type: 'POST',
                data: { phoneNumber: phoneNumber },
                success: function (response) {

                    Swal.close();

                    if (response.success === false && response.message === "UserNotFound") {
                        // Kullanıcı Yoksa
                        Swal.fire({
                            icon: 'info',
                            title: 'Hasta Kaydı Gerekli',
                            text: 'Randevu sistemini kullanabilmek için kayıt oluşturmalısınız.',
                            confirmButtonText: 'Kayıt Ol',
                            confirmButtonColor: '#007bff', // Mavi Buton
                            showCancelButton: true,
                            cancelButtonText: 'Kapat'
                        }).then((r) => { if (r.isConfirmed) window.location.href = "/Register/Index"; });
                    }
                    else if (response.success === true && response.message === "CodeSent") {

                        // --- 4. GÜVENLİK KODU (MAVİ/TEMİZ TEMA) ---
                        let timerInterval;

                        Swal.fire({
                            title: 'Güvenlik Doğrulaması',
                            html: `
                                <div style="text-align:center;">
                                    <div style="background:#f8f9fa; padding:10px; border-radius:8px; margin-bottom:15px; font-size:14px; color:#555;">
                                        <b>${userEmail}</b> adresine gönderilen kodu giriniz.
                                    </div>
                                    <div class="progress" style="height: 6px; margin: 15px 0; background-color:#e9ecef;">
                                      <div id="otp-progress" class="progress-bar" role="progressbar" style="width: 100%; background-color:#007bff;"></div>
                                    </div>
                                    <div class="d-flex justify-content-between text-muted" style="font-size:12px;">
                                        <span>Süre:</span>
                                        <span id="otp-timer-text" style="font-weight:bold; color:#007bff;">120 sn</span>
                                    </div>
                                </div>
                            `,
                            input: 'text',
                            inputAttributes: {
                                placeholder: '------',
                                maxlength: '6',
                                // DÜZELTME BURADA YAPILDI:
                                style: 'text-align: center; letter-spacing: 12px; font-size: 26px; border: 1px solid #ced4da; border-radius: 8px; color: #495057; font-weight: 600; box-shadow:none; width: 90%; max-width: 350px; margin: 0 auto; box-sizing: border-box;'
                            },
                            showCancelButton: true,
                            confirmButtonText: 'Doğrula',
                            cancelButtonText: 'İptal',
                            confirmButtonColor: '#007bff', // Hastane Mavisi
                            cancelButtonColor: '#6c757d', // Gri
                            showLoaderOnConfirm: true,
                            customClass: {
                                input: 'form-control form-control-lg' // Bootstrap stili
                            },

                            didOpen: () => {
                                const progressBar = Swal.getHtmlContainer().querySelector('#otp-progress');
                                const timerText = Swal.getHtmlContainer().querySelector('#otp-timer-text');
                                let totalTime = 120;
                                let timeLeft = 120;

                                timerInterval = setInterval(() => {
                                    timeLeft--;
                                    let percentage = (timeLeft / totalTime) * 100;
                                    progressBar.style.width = percentage + "%";
                                    timerText.textContent = timeLeft + " sn";

                                    if (timeLeft <= 0) {
                                        clearInterval(timerInterval);
                                        Swal.close();
                                        Toast.fire({ icon: 'warning', title: 'Süre doldu.' });
                                    }
                                }, 1000);
                            },
                            willClose: () => { clearInterval(timerInterval); },

                            preConfirm: (inputCode) => {
                                if (!inputCode || inputCode.length < 6) {
                                    Swal.showValidationMessage('Lütfen kodu eksiksiz giriniz.');
                                    return false;
                                }
                                var finalData = formData + "&userCode=" + inputCode;

                                return $.ajax({
                                    url: '/Default/DefaultAppointment',
                                    type: 'POST',
                                    data: finalData
                                }).then(res => {
                                    if (!res.success) throw new Error(res.message);
                                    return res;
                                }).catch(err => {
                                    Swal.showValidationMessage('Hatalı kod, lütfen kontrol ediniz.');
                                });
                            }
                        }).then((result) => {
                            if (result.isConfirmed) {
                                // --- 5. FİNAL: TEMİZ & PROFESYONEL BİLET ---
                                // --- 5. FİNAL: TEMİZ & PROFESYONEL BİLET ---
                                Swal.fire({
                                    title: 'Talebiniz Oluşturuldu',
                                    html: `
        <div class="ticket-card mt-3">
            <div class="ticket-header">
                <span><i class="fas fa-hospital-alt me-2"></i> MEDINOVA</span>
                <span class="badge bg-light text-primary" style="font-weight:600;">İşlemde</span>
            </div>
            <div class="ticket-body">
                <div class="text-center mb-3">
                    <i class="fas fa-check-circle text-primary" style="font-size:3rem; opacity:0.2;"></i>
                    <p class="mt-2 text-muted" style="font-size:13px;">
                        Randevu talebiniz başarıyla alınmıştır.
                        <br>Durumunu takip etmek için lütfen giriş yapınız.
                    </p>
                </div>
                <div class="ticket-row">
                    <span class="ticket-label">Bölüm</span>
                    <span class="ticket-value">${deptName}</span>
                </div>
                <div class="ticket-row">
                    <span class="ticket-label">Doktor</span>
                    <span class="ticket-value">${docName}</span>
                </div>
                <div class="ticket-row">
                    <span class="ticket-label">Tarih & Saat</span>
                    <span class="ticket-value">${appDate} - ${appTime}</span>
                </div>
            </div>
        </div>
    `,
                                    icon: null,
                                    // Buton metnini ve rengini değiştirdik
                                    confirmButtonText: 'Giriş Yap ve Takip Et <i class="fas fa-arrow-right ms-2"></i>',
                                    confirmButtonColor: '#007bff',
                                    width: 450
                                }).then((result) => {
                                    if (result.isConfirmed) {
                                        // --- DÜZELTME BURADA: Login sayfasına yönlendiriyoruz ---
                                        window.location.href = "/Account/Login";
                                    }
                                });
                            }
                        });
                    }
                }
            });
        });

        $(".form-control, .form-select").on('input change', function () {
            if ($(this).val()) $(this).removeClass("input-error");
        });
    });
</script>


<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
